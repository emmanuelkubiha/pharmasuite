<?php
/**
 * PAGE PARAMÈTRES - STORE SUITE
 * Configuration du système (Admin uniquement)
 */
require_once 'protection_pages.php';
require_admin(); // Vérifier que c'est un admin

$page_title = 'Paramètres du Système';

// Traitement du formulaire
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $error = '';
    $success = '';
    
    try {
        $nom_boutique = trim($_POST['nom_boutique'] ?? '');
        $devise = trim($_POST['devise'] ?? '');
        $couleur_primaire = trim($_POST['couleur_primaire'] ?? '');
        $couleur_secondaire = trim($_POST['couleur_secondaire'] ?? '');
        $adresse_boutique = trim($_POST['adresse_boutique'] ?? '');
        $telephone_boutique = trim($_POST['telephone_boutique'] ?? '');
        $email_boutique = trim($_POST['email_boutique'] ?? '');
        
        if (empty($nom_boutique)) {
            throw new Exception('Le nom de la boutique est obligatoire');
        }
        
        if (empty($devise)) {
            throw new Exception('La devise est obligatoire');
        }
        
        // Mise à jour de la configuration
        $sql = "UPDATE configuration SET 
                nom_boutique = ?,
                devise = ?,
                couleur_primaire = ?,
                couleur_secondaire = ?,
                adresse_boutique = ?,
                telephone_boutique = ?,
                email_boutique = ?
                WHERE id_config = 1";
        
        db_execute($sql, [
            $nom_boutique,
            $devise,
            $couleur_primaire,
            $couleur_secondaire,
            $adresse_boutique,
            $telephone_boutique,
            $email_boutique
        ]);
        
        $success = 'Paramètres mis à jour avec succès. Actualisez la page pour voir les changements.';
        
        // Recharger la config
        $config = get_system_config();
        $nom_boutique = $config['nom_boutique'];
        $devise = $config['devise'];
        $couleur_primaire = $config['couleur_primaire'];
        $couleur_secondaire = $config['couleur_secondaire'];
        
    } catch (Exception $e) {
        $error = $e->getMessage();
    }
}

// Récupérer les statistiques système
$stats_systeme = db_fetch_one("
    SELECT 
        (SELECT COUNT(*) FROM produits WHERE est_actif = 1) as nb_produits,
        (SELECT COUNT(*) FROM categories WHERE est_actif = 1) as nb_categories,
        (SELECT COUNT(*) FROM clients WHERE est_actif = 1) as nb_clients,
        (SELECT COUNT(*) FROM utilisateurs WHERE est_actif = 1) as nb_utilisateurs,
        (SELECT COUNT(*) FROM ventes WHERE statut = 'validee') as nb_ventes,
        (SELECT SUM(quantite_stock) FROM produits WHERE est_actif = 1) as stock_total
");

include 'header.php';
?>

<div class="container-xl">
    <div class="page-header d-print-none mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="page-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Paramètres du Système
                </h2>
                <div class="text-muted mt-1">Configuration générale de la boutique</div>
            </div>
            <div class="col-auto">
                <a href="accueil.php" class="btn btn-outline-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                        <line x1="5" y1="12" x2="9" y2="16"/>
                        <line x1="5" y1="12" x2="9" y2="8"/>
                    </svg>
                    Retour
                </a>
            </div>
        </div>
    </div>

    <?php if (isset($error) && $error): ?>
    <div class="alert alert-danger alert-dismissible" role="alert">
        <div class="d-flex">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>
            </div>
            <div><?php echo e($error); ?></div>
        </div>
        <a class="btn-close" data-bs-dismiss="alert"></a>
    </div>
    <?php endif; ?>

    <?php if (isset($success) && $success): ?>
    <div class="alert alert-success alert-dismissible" role="alert">
        <div class="d-flex">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9" /><path d="M9 12l2 2l4 -4" /></svg>
            </div>
            <div><?php echo e($success); ?></div>
        </div>
        <a class="btn-close" data-bs-dismiss="alert"></a>
    </div>
    <?php endif; ?>

    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4 shadow-sm">
                <div class="card-header" style="background: linear-gradient(135deg, <?php echo $couleur_primaire; ?>, <?php echo $couleur_secondaire; ?>); color: white;">
                    <h3 class="card-title mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="19" x2="20" y2="19"/><polyline points="4 15 8 9 12 11 16 6 20 10"/></svg>
                        Statistiques du système
                    </h3>
                </div>
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="avatar avatar-lg" style="background: linear-gradient(135deg, <?php echo $couleur_primaire; ?>, <?php echo $couleur_secondaire; ?>); color: white;">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5"/><path d="M12 12l8 -4.5"/><path d="M12 12l0 9"/><path d="M12 12l-8 -4.5"/></svg>
                                </span>
                            </div>
                            <div class="col">
                                <div class="text-muted small text-uppercase">Produits actifs</div>
                                <strong class="fs-2" style="color: <?php echo $couleur_primaire; ?>;"><?php echo number_format($stats_systeme['nb_produits']); ?></strong>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="avatar avatar-lg bg-success-lt">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon text-success" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/><path d="M21 21v-2a4 4 0 0 0 -3 -3.85"/></svg>
                                </span>
                            </div>
                            <div class="col">
                                <div class="text-muted small text-uppercase">Clients</div>
                                <strong class="fs-2 text-success"><?php echo number_format($stats_systeme['nb_clients']); ?></strong>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="avatar avatar-lg bg-info-lt">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon text-info" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="6" cy="19" r="2"/><circle cx="17" cy="19" r="2"/><path d="M17 17h-11v-14h-2"/><path d="M6 5l14 1l-1 7h-13"/></svg>
                                </span>
                            </div>
                            <div class="col">
                                <div class="text-muted small text-uppercase">Ventes totales</div>
                                <strong class="fs-2 text-info"><?php echo number_format($stats_systeme['nb_ventes']); ?></strong>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="avatar avatar-lg bg-warning-lt">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon text-warning" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
                                </span>
                            </div>
                            <div class="col">
                                <div class="text-muted small text-uppercase">Stock total</div>
                                <strong class="fs-2 text-warning"><?php echo number_format($stats_systeme['stock_total']); ?></strong>
                                <small class="text-muted d-block">unités</small>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="avatar avatar-lg bg-primary-lt">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon text-primary" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"/><line x1="19" y1="7" x2="19" y2="10"/><line x1="19" y1="14" x2="19" y2="14.01"/></svg>
                                </span>
                            </div>
                            <div class="col">
                                <div class="text-muted small text-uppercase">Utilisateurs</div>
                                <strong class="fs-2 text-primary"><?php echo number_format($stats_systeme['nb_utilisateurs']); ?></strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="text-center">
                        <small class="text-muted">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
                            Dernière mise à jour : <?php echo date('d/m/Y H:i'); ?>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Configuration de la boutique</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        <h4 class="mb-3">Informations générales</h4>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label required">
                                    Nom de la boutique
                                    <span class="text-muted ms-1" data-bs-toggle="tooltip" title="Ce nom apparaît partout dans l'application">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="14" height="14" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12.01" y2="8"/><polyline points="11 12 12 12 12 16 13 16"/></svg>
                                    </span>
                                </label>
                                <input type="text" class="form-control" name="nom_boutique" value="<?php echo e($nom_boutique); ?>" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label required">
                                    Devise
                                    <span class="text-muted ms-1" data-bs-toggle="tooltip" title="Sélectionnez la monnaie utilisée dans votre boutique">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="14" height="14" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12.01" y2="8"/><polyline points="11 12 12 12 12 16 13 16"/></svg>
                                    </span>
                                </label>
                                <select class="form-select" name="devise" required>
                                    <option value="CDF" <?php echo $devise === 'CDF' ? 'selected' : ''; ?>>CDF (Franc Congolais)</option>
                                    <option value="USD" <?php echo $devise === 'USD' ? 'selected' : ''; ?>>USD (Dollar Américain)</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Adresse</label>
                            <input type="text" class="form-control" name="adresse_boutique" value="<?php echo isset($config['adresse_boutique']) ? e($config['adresse_boutique']) : ''; ?>" placeholder="Ex: 123 Avenue Lumumba, Kinshasa">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Téléphone</label>
                                <input type="tel" class="form-control" name="telephone_boutique" value="<?php echo isset($config['telephone_boutique']) ? e($config['telephone_boutique']) : ''; ?>" placeholder="+243 XXX XXX XXX">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email_boutique" value="<?php echo isset($config['email_boutique']) ? e($config['email_boutique']) : ''; ?>" placeholder="contact@boutique.com">
                            </div>
                        </div>

                        <hr class="my-4">
                        <h4 class="mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"/><polyline points="7 9 12 4 17 9"/><line x1="12" y1="4" x2="12" y2="16"/></svg>
                            Logo du système
                            <span class="text-muted ms-1" data-bs-toggle="tooltip" title="Image affichée dans l'en-tête et le chargement">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="14" height="14" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12.01" y2="8"/><polyline points="11 12 12 12 12 16 13 16"/></svg>
                            </span>
                        </h4>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <?php 
                                $logo_actuel = isset($config['logo_boutique']) ? $config['logo_boutique'] : '';
                                $logo_existe = !empty($logo_actuel) && file_exists(__DIR__ . '/uploads/logos/' . $logo_actuel);
                                ?>
                                <?php if ($logo_existe): ?>
                                <div class="card">
                                    <div class="card-body text-center p-4">
                                        <img src="<?php echo BASE_URL . 'uploads/logos/' . e($logo_actuel); ?>" alt="Logo actuel" class="img-fluid mb-2" style="max-height: 100px;">
                                        <div class="text-muted small">Logo actuel</div>
                                    </div>
                                </div>
                                <?php else: ?>
                                <div class="card">
                                    <div class="card-body text-center p-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-muted mb-2" width="48" height="48" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M6.331 8h11.339a2 2 0 0 1 1.977 2.304l-1.255 8.152a3 3 0 0 1 -2.966 2.544h-6.852a3 3 0 0 1 -2.965 -2.544l-1.255 -8.152a2 2 0 0 1 1.977 -2.304z"/>
                                            <path d="M9 11v-5a3 3 0 0 1 6 0v5"/>
                                        </svg>
                                        <div class="text-muted small">Aucun logo</div>
                                    </div>
                                </div>
                                <?php endif; ?>
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Uploader un nouveau logo</label>
                                <input type="file" class="form-control" name="logo_boutique" accept="image/*">
                                <small class="text-muted">Format recommandé: PNG ou JPG, max 2MB, dimensions 200x200px</small>
                                <div class="alert alert-warning mt-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 9v2m0 4v.01"/><path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"/></svg>
                                    <strong>Note:</strong> Fonctionnalité upload à implémenter avec traitement PHP (enctype="multipart/form-data")
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">
                        <h4 class="mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 21a9 9 0 1 1 0 -18a9 9 0 0 1 0 18z"/><path d="M3.6 9h16.8"/><path d="M3.6 15h16.8"/><circle cx="12" cy="12" r="9"/></svg>
                            Personnalisation
                            <span class="text-muted ms-1" data-bs-toggle="tooltip" title="Choisissez les couleurs de votre interface">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="14" height="14" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12.01" y2="8"/><polyline points="11 12 12 12 12 16 13 16"/></svg>
                            </span>
                        </h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Couleur primaire</label>
                                <div class="input-group">
                                    <input type="color" class="form-control form-control-color" name="couleur_primaire" value="<?php echo e($couleur_primaire); ?>">
                                    <input type="text" class="form-control" value="<?php echo e($couleur_primaire); ?>" readonly>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Couleur secondaire</label>
                                <div class="input-group">
                                    <input type="color" class="form-control form-control-color" name="couleur_secondaire" value="<?php echo e($couleur_secondaire); ?>">
                                    <input type="text" class="form-control" value="<?php echo e($couleur_secondaire); ?>" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><line x1="12" y1="8" x2="12.01" y2="8"/><polyline points="11 12 12 12 12 16 13 16"/></svg>
                            Actualisez la page (F5) après la sauvegarde pour voir les changements de couleurs.
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10"/></svg>
                                Enregistrer les paramètres
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialiser les tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Synchroniser les inputs de couleur avec les champs texte
    document.querySelectorAll('input[type="color"]').forEach(function(colorInput) {
        colorInput.addEventListener('input', function() {
            this.nextElementSibling.value = this.value;
        });
    });
});
</script>

<?php include 'footer.php'; ?>
