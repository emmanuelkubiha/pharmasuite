<?php
    session_start();
    require_once("connexion.php");

    $_GET['page'] = 5;

    $mc = "";

    if(isset($_POST['fac']))
    {
        $mc = htmlspecialchars(trim(addslashes($_POST['fac'])));
    }

    $id_utilisateur = $_SESSION['ID'];
	
    $req = "select * from UTILISATEUR where ID_UTILISATEUR = $id_utilisateur ";
    $rs = mysqli_query($connexion, $req);
    
    $ET = mysqli_fetch_assoc($rs);
?>
<!doctype html>

<html lang="FR">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title><?php echo $ET100['TITRE']?> - Rapports</title>
    <!-- CSS files -->
    <link href="./dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="./dist/css/tabler-flags.min.css" rel="stylesheet"/>
    <link href="./dist/css/tabler-payments.min.css" rel="stylesheet"/>
    <link href="./dist/css/tabler-vendors.min.css" rel="stylesheet"/>
    <link href="./dist/css/demo.min.css" rel="stylesheet"/>
  </head>
  <style>
    .table-responsive{
        height: calc(48rem + 10px);
    }
  </style>
  <body class="antialiased">
    <div class="wrapper">
      <?php include('header.php'); ?>
      <div class="page-wrapper">
        <div class="container-xl">
          <!-- Page title -->
          <div class="page-header d-print-none">
            <div class="row align-items-center">
              <div class="col">
                <h2 class="page-title">
                  Rapports
                </h2>
              </div>
              <!-- Page title actions -->
              <div class="col-auto ms-auto d-print-none">
                <button type="button" class="btn btn-primary d-none d-sm-inline-block" onclick="javascript:window.print();">
                  <!-- Download SVG icon from http://tabler-icons.io/i/printer -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" /><path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" /><rect x="7" y="13" width="10" height="8" rx="2" /></svg>
                  Imprimer
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="page-body">
          <div class="container-xl">
            <div class="card card-lg">
              <div class="card-body">
                <div class="row">
                  <div class="col-6">
                    <p class="h3" style="color: #e2e215db!important;font-size: 1.2rem!important;"><?php echo $ET100['TITRE']?></p>
                    <address>
                      <?php echo $ET100['NUM_NATIONAL']?><br>
                      <?php echo $ET100['ADRESSE']?><br>
                      <?php echo $ET100['PHONE']?>
                    </address>
                  </div>
                  <div class="col-6 text-end">
                    <address>Le <?php echo date('d/m/Y'); ?></address>
                  </div>
                  <div class="col-12 my-5 text-center">
                    <?php if(isset($_GET['rapport'])){?>
                        <?php if($_GET['rapport'] == 1){?>
                            <h1>Produits</h1>
                        <?php } else if($_GET['rapport'] == 2){?>
                            <h1>Toutes les ventes</h1>
                        <?php } else if($_GET['rapport'] == 3){?>
                            <h1><?php echo $_GET['jour'] ?></h1>
                        <?php } else if($_GET['rapport'] == 6){?>
                            <h1>Toutes les ventes annulées</h1>
                        <?php } else if($_GET['rapport'] == 4){?>
                            <h1><?php echo $_GET['jour'] ?></h1>
                        <?php } else if($_GET['rapport'] == 5){?>
                            <h1>Produits à stock faible</h1>
                        <?php } else if($_GET['rapport'] == 7){?>
                            <h1>Produits à stock fini</h1>
                        <?php } ?>
                    <?php } ?>
                  </div>
                </div>
                <?php if(isset($_GET['rapport'])){
                ?>
                    <div id="cadrer">
                    <?php if($_GET['rapport'] == 1){?>
                        <table id="table_produit" class="table table-transparent">
                        <thead>
                            <tr>
                            <th class="text-center" style="width: 2%"></th>
                            <th>Produit</th>
                            <th class="text-center" style="width: 10%">Prix d'achat</th>
                            <th class="text-center" style="width: 10%">Prix vente</th>
                            <th class="text-center" style="width: 10%">Quantité</th>
                            </tr>
                        </thead>
                        
                        <?php
                            $i = 1;
                            $montant = 0;
                            $prix_achat = 0;
                            $prix_vente = 0;

                            $req = "select count(*) as nombre from PRODUIT where TITRE_PRODUIT like '%$mc%' ";
                            $rs200 = mysqli_query($connexion,$req);
                            $ET200=mysqli_fetch_assoc($rs200);

                            $req = "select * from PRODUIT where TITRE_PRODUIT like '%$mc%' order by TITRE_PRODUIT ";
                            $rs20 = mysqli_query($connexion,$req);
                            while($ET20=mysqli_fetch_assoc($rs20)){
                        ?>
                        <tr>
                            <td class="text-center"><?php echo $i++ ?></td>
                            <td>
                            <p class="strong mb-1"><?php echo $ET20['TITRE_PRODUIT'] ?></p>
                            </td>
                            <td class="text-center"><?php echo $ET20['PRIX_ACHAT_PRODUIT'] ?> $</td>
                            <td class="text-center"><?php echo $ET20['PRIX_VENTE_PRODUIT'] ?> $</td>
                            <td class="text-center"><?php echo $ET20['QUANTITE_PRODUIT'] ?></td>
                        </tr>
                        <?php
                            $montant += $ET20['QUANTITE_PRODUIT'];
                            $prix_achat += $ET20['PRIX_ACHAT_PRODUIT'];
                            $prix_vente += $ET20['PRIX_VENTE_PRODUIT'];
                          }
                        ?>
                        </table>
                    <?php } else if($_GET['rapport'] == 2){?>
                        <table id="table_produit" class="table table-transparent">
                        <thead>
                            <tr>
                            <th class="text-center" style="width: 2%"></th>
                            <th>Produit</th>
                            <th class="text-center" style="width: 20%">Date</th>
                            <th class="text-center" style="width: 10%">Quantité</th>
                            <th class="text-center" style="width: 10%">P.U</th>
                            <th class="text-center" style="width: 10%">Total</th>
                            </tr>
                        </thead>
                        
                        <?php
                            $i = 1;
                            $montant = 0;
                            $prix_achat = 0;
                            $prix_unitaire = 0;

                            $req = "select count(*) as nombre from VENTE ";
                            $rs200 = mysqli_query($connexion,$req);
                            $ET200=mysqli_fetch_assoc($rs200);

                            $req = "select * from VENTE order by ID_VENTE desc";
                            $rs201 = mysqli_query($connexion,$req);
                            while($ET201=mysqli_fetch_assoc($rs201)){

                                $id_produit = $ET201['ID_PRODUIT'];

                            $req = "select * from PRODUIT where ID_PRODUIT = $id_produit ";
                            $rs20 = mysqli_query($connexion,$req);
                            if($ET20=mysqli_fetch_assoc($rs20)){
                        ?>
                        <tr>
                            <td class="text-center"><?php echo $i++ ?></td>
                            <td>
                            <p class="strong mb-1"><?php echo $ET20['TITRE_PRODUIT'] ?></p>
                            </td>
                            <td class="text-end"><?php echo 'Le '.date("d/m/Y à h:m:s", strtotime($ET201['DATE_VENTE'])) ?></td>
                            <td class="text-center"><?php echo $ET201['QUANTITE_VENTE'] ?></td>
                            <td class="text-center"><?php echo $ET201['PRIX_VENTE'] ?> $</td>
                            <td class="text-center"><?php echo ($ET201['QUANTITE_VENTE'] * $ET201['PRIX_VENTE']) ?> $</td>
                        </tr>
                        <?php
                              $prix_achat += ($ET201['QUANTITE_VENTE'] * $ET201['PRIX_ACHAT']);
                              $montant += ($ET201['QUANTITE_VENTE'] * $ET201['PRIX_VENTE']);
                              $prix_unitaire += $ET201['PRIX_VENTE'];
							              } }
                        ?>
                        <tr>
                            <td colspan="4" class="font-weight-bold text-uppercase text-end">Total général</td>
                            <td class="font-weight-bold text-center"></td>
                            <td class="font-weight-bold text-center"><?php echo $montant ?> $</td>
                        </tr>
                        <tr>
                            <td colspan="4" class="font-weight-bold text-uppercase text-end">Bénéfice général</td>
                            <td class="font-weight-bold text-center"></td>
                            <td class="font-weight-bold text-center"><?php echo $montant - $prix_achat ?> $</td>
                        </tr>
                        </table>
                    <?php } else if($_GET['rapport'] == 3){?>
                        <table id="table_produit" class="table table-transparent">
                        <thead>
                            <tr>
                            <th class="text-center" style="width: 2%"></th>
                            <th>Produit</th>
                            <th class="text-center" style="width: 20%">Heure</th>
                            <th class="text-center" style="width: 10%">Quantité</th>
                            <th class="text-center" style="width: 10%">P.U</th>
                            <th class="text-center" style="width: 10%">Total</th>
                            </tr>
                        </thead>
                        
                        <?php
                            $i = 1;
                            $montant = 0;
                            $prix_achat = 0;
                            $prix_unitaire = 0;

                            $date = $_GET['date'];


                            $req = "select count(*) as nombre from VENTE where date(DATE_VENTE) like '%$date%' ";
                            $rs200 = mysqli_query($connexion,$req);
                            $ET200=mysqli_fetch_assoc($rs200);

                            $req = "select * from VENTE where date(DATE_VENTE) like '%$date%' ";
                            $rs201 = mysqli_query($connexion,$req);
                            while($ET201=mysqli_fetch_assoc($rs201)){

                            $id_produit = $ET201['ID_PRODUIT'];

                            $req = "select * from PRODUIT where ID_PRODUIT = $id_produit ";
                            $rs20 = mysqli_query($connexion,$req);
                            if($ET20=mysqli_fetch_assoc($rs20)){
                        ?>
                        <tr>
                            <td class="text-center"><?php echo $i++ ?></td>
                            <td>
                            <p class="strong mb-1"><?php echo $ET20['TITRE_PRODUIT'] ?></p>
                            </td>
                            <td class="text-center"><?php echo date("h:m:s", strtotime($ET201['DATE_VENTE'])) ?></td>
                            <td class="text-center"><?php echo $ET201['QUANTITE_VENTE'] ?></td>
                            <td class="text-center"><?php echo $ET201['PRIX_VENTE'] ?> $</td>
                            <td class="text-center"><?php echo ($ET201['QUANTITE_VENTE'] * $ET201['PRIX_VENTE']) ?> $</td>
                        </tr>
                        <?php
                              $prix_achat += ($ET201['QUANTITE_VENTE'] * $ET201['PRIX_ACHAT']);
                              $montant += ($ET201['QUANTITE_VENTE'] * $ET201['PRIX_VENTE']);
                              $prix_unitaire += $ET201['PRIX_VENTE'];
							              } }
                        ?>
                        <tr>
                            <td colspan="4" class="font-weight-bold text-uppercase text-end">Total général</td>
                            <td class="font-weight-bold text-center"></td>
                            <td class="font-weight-bold text-center"><?php echo $montant ?> $</td>
                        </tr>
                        <tr>
                            <td colspan="4" class="font-weight-bold text-uppercase text-end">Bénéfice général</td>
                            <td class="font-weight-bold text-center"></td>
                            <td class="font-weight-bold text-center"><?php echo $montant - $prix_achat ?> $</td>
                        </tr>
                        </table>
                    <?php } else if($_GET['rapport'] == 6){?>
                        <table id="table_produit" class="table table-transparent">
                        <thead>
                            <tr>
                            <th class="text-center" style="width: 2%"></th>
                            <th>Produit</th>
                            <th class="text-center" style="width: 20%">Date</th>
                            <th class="text-center" style="width: 10%">Quantité</th>
                            <th class="text-center" style="width: 10%">P.U</th>
                            <th class="text-center" style="width: 10%">Total</th>
                            </tr>
                        </thead>
                        
                        <?php
                            $i = 1;
                            $montant = 0;
                            $prix_achat = 0;
                            $prix_unitaire = 0;

                            $req = "select count(*) as nombre from VENTE_ANNULEE ";
                            $rs200 = mysqli_query($connexion,$req);
                            $ET200=mysqli_fetch_assoc($rs200);

                            $req = "select * from VENTE_ANNULEE order by ID_VENTE_ANNULEE desc";
                            $rs201 = mysqli_query($connexion,$req);
                            while($ET201=mysqli_fetch_assoc($rs201)){

                                $id_produit = $ET201['ID_PRODUIT'];

                            $req = "select * from PRODUIT where ID_PRODUIT = $id_produit ";
                            $rs20 = mysqli_query($connexion,$req);
                            if($ET20=mysqli_fetch_assoc($rs20)){
                        ?>
                        <tr>
                            <td class="text-center"><?php echo $i++ ?></td>
                            <td>
                            <p class="strong mb-1"><?php echo $ET20['TITRE_PRODUIT'] ?></p>
                            </td>
                            <td class="text-end"><?php echo 'Le '.date("d/m/Y à h:m:s", strtotime($ET201['DATE_VENTE_ANNULEE'])) ?></td>
                            <td class="text-center"><?php echo $ET201['QUANTITE_VENTE_ANNULEE'] ?></td>
                            <td class="text-center"><?php echo $ET201['PRIX_VENTE_ANNULEE'] ?> $</td>
                            <td class="text-center"><?php echo ($ET201['QUANTITE_VENTE_ANNULEE'] * $ET201['PRIX_VENTE_ANNULEE']) ?> $</td>
                        </tr>
                        <?php
                              $montant += ($ET201['QUANTITE_VENTE_ANNULEE'] * $ET201['PRIX_VENTE_ANNULEE']);
                              $prix_unitaire += $ET201['PRIX_VENTE_ANNULEE'];
							              } }
                        ?>
                        <tr>
                            <td colspan="4" class="font-weight-bold text-uppercase text-end">Total général</td>
                            <td class="font-weight-bold text-center"></td>
                            <td class="font-weight-bold text-center"><?php echo $montant ?> $</td>
                        </tr>
                        </table>
                    <?php } else if($_GET['rapport'] == 4){?>
                        <table id="table_produit" class="table table-transparent">
                        <thead>
                            <tr>
                            <th class="text-center" style="width: 2%"></th>
                            <th>Produit</th>
                            <th class="text-center" style="width: 20%">Heure</th>
                            <th class="text-center" style="width: 10%">Quantité</th>
                            <th class="text-center" style="width: 10%">P.U</th>
                            <th class="text-center" style="width: 10%">Total</th>
                            </tr>
                        </thead>
                        
                        <?php
                            $i = 1;
                            $montant = 0;
                            $prix_achat = 0;
                            $prix_unitaire = 0;

                            $date = $_GET['date'];


                            $req = "select count(*) as nombre from VENTE_ANNULEE where date(DATE_VENTE_ANNULEE) like '%$date%' ";
                            $rs200 = mysqli_query($connexion,$req);
                            $ET200=mysqli_fetch_assoc($rs200);

                            $req = "select * from VENTE_ANNULEE where date(DATE_VENTE_ANNULEE) like '%$date%' ";
                            $rs201 = mysqli_query($connexion,$req);
                            while($ET201=mysqli_fetch_assoc($rs201)){

                            $id_produit = $ET201['ID_PRODUIT'];

                            $req = "select * from PRODUIT where ID_PRODUIT = $id_produit ";
                            $rs20 = mysqli_query($connexion,$req);
                            if($ET20=mysqli_fetch_assoc($rs20)){
                        ?>
                        <tr>
                            <td class="text-center"><?php echo $i++ ?></td>
                            <td>
                            <p class="strong mb-1"><?php echo $ET20['TITRE_PRODUIT'] ?></p>
                            </td>
                            <td class="text-center"><?php echo date("h:m:s", strtotime($ET201['DATE_VENTE_ANNULEE'])) ?></td>
                            <td class="text-center"><?php echo $ET201['QUANTITE_VENTE_ANNULEE'] ?></td>
                            <td class="text-center"><?php echo $ET201['PRIX_VENTE_ANNULEE'] ?> $</td>
                            <td class="text-center"><?php echo ($ET201['QUANTITE_VENTE_ANNULEE'] * $ET201['PRIX_VENTE_ANNULEE']) ?> $</td>
                        </tr>
                        <?php
                              $montant += ($ET201['QUANTITE_VENTE_ANNULEE'] * $ET201['PRIX_VENTE_ANNULEE']);
                              $prix_unitaire += $ET201['PRIX_VENTE_ANNULEE'];
							              } }
                        ?>
                        <tr>
                            <td colspan="4" class="font-weight-bold text-uppercase text-end">Total général</td>
                            <td class="font-weight-bold text-center"></td>
                            <td class="font-weight-bold text-center"><?php echo $montant ?> $</td>
                        </tr>
                        </table>
                   <?php } else if($_GET['rapport'] == 5){?>
                        <table id="table_produit" class="table table-transparent">
                        <thead>
                            <tr>
                            <th class="text-center" style="width: 2%"></th>
                            <th>Produit</th>
                            <th class="text-center" style="width: 10%">Prix d'achat</th>
                            <th class="text-center" style="width: 10%">Prix vente</th>
                            <th class="text-center" style="width: 10%">Quantité</th>
                            </tr>
                        </thead>
                        
                        <?php
                            $i = 1;
                            $montant = 0;
                            $prix_achat = 0;
                            $prix_vente = 0;

                            $req = "select count(*) as nombre from PRODUIT where (QUANTITE_PRODUIT <= SEUIL_PRODUIT) and TITRE_PRODUIT like '%$mc%' ";
                            $rs200 = mysqli_query($connexion,$req);
                            $ET200=mysqli_fetch_assoc($rs200);

                            $req = "select * from PRODUIT where (QUANTITE_PRODUIT <= SEUIL_PRODUIT) and TITRE_PRODUIT like '%$mc%' order by TITRE_PRODUIT ";
                            $rs20 = mysqli_query($connexion,$req);
                            while($ET20=mysqli_fetch_assoc($rs20)){
                        ?>
                        <tr>
                            <td class="text-center"><?php echo $i++ ?></td>
                            <td>
                            <p class="strong mb-1"><?php echo $ET20['TITRE_PRODUIT'] ?></p>
                            </td>
                            <td class="text-center"><?php echo $ET20['PRIX_ACHAT_PRODUIT'] ?> $</td>
                            <td class="text-center"><?php echo $ET20['PRIX_VENTE_PRODUIT'] ?> $</td>
                            <td class="text-center"><?php echo $ET20['QUANTITE_PRODUIT'] ?></td>
                        </tr>
                        <?php
                            $montant += $ET20['QUANTITE_PRODUIT'];
                            $prix_achat += $ET20['PRIX_ACHAT_PRODUIT'];
                            $prix_vente += $ET20['PRIX_VENTE_PRODUIT'];
                          }
                        ?>
                        </table>
                    <?php } else if($_GET['rapport'] == 7){?>
                        <table id="table_produit" class="table table-transparent">
                        <thead>
                            <tr>
                            <th class="text-center" style="width: 2%"></th>
                            <th>Produit</th>
                            <th class="text-center" style="width: 10%">Prix d'achat</th>
                            <th class="text-center" style="width: 10%">Prix vente</th>
                            <th class="text-center" style="width: 10%">Quantité</th>
                            </tr>
                        </thead>
                        
                        <?php
                            $i = 1;
                            $montant = 0;
                            $prix_achat = 0;
                            $prix_vente = 0;

                            $req = "select count(*) as nombre from PRODUIT where (QUANTITE_PRODUIT = 0) and TITRE_PRODUIT like '%$mc%' ";
                            $rs200 = mysqli_query($connexion,$req);
                            $ET200=mysqli_fetch_assoc($rs200);

                            $req = "select * from PRODUIT where (QUANTITE_PRODUIT = 0) and TITRE_PRODUIT like '%$mc%' order by TITRE_PRODUIT ";
                            $rs20 = mysqli_query($connexion,$req);
                            while($ET20=mysqli_fetch_assoc($rs20)){
                        ?>
                        <tr>
                            <td class="text-center"><?php echo $i++ ?></td>
                            <td>
                            <p class="strong mb-1"><?php echo $ET20['TITRE_PRODUIT'] ?></p>
                            </td>
                            <td class="text-center"><?php echo $ET20['PRIX_ACHAT_PRODUIT'] ?> $</td>
                            <td class="text-center"><?php echo $ET20['PRIX_VENTE_PRODUIT'] ?> $</td>
                            <td class="text-center"><?php echo $ET20['QUANTITE_PRODUIT'] ?></td>
                        </tr>
                        <?php
                            $montant += $ET20['QUANTITE_PRODUIT'];
                            $prix_achat += $ET20['PRIX_ACHAT_PRODUIT'];
                            $prix_vente += $ET20['PRIX_VENTE_PRODUIT'];
                          }
                        ?>
                        </table>
                    <?php } ?>
                    </div>
                <?php } ?>

                
                <p class="text-muted text-center mt-5"><?php echo $ET100['ADRESSE']?> - <?php echo $ET100['PHONE']?></p>
              </div>
            </div>
          </div>
        </div>
        <?php include('footer.php') ?>
      </div>
    </div>
    <!-- Libs JS -->
    <!-- Tabler Core -->
    <script src="./dist/js/tabler.min.js"></script>

    <script src="./dist/js/jquery-3.2.1.min.js"></script>
    <script src="./dist/js/sweetalert2.all.js"></script>
    <script src="./dist/js/sweetalert2.js"></script>
    <script src="./dist/js/sweetalert2.min.js"></script>
    <script src="./dist/js/sweetalert2.all.min.js"></script>
    <script src="./dist/js/traitement.js"></script>
    <script src="./dist/js/nous.js"></script>
    <script>

$('#search_produit').on('keyup input blur select click', function () {
    var value = $(this).val().toLowerCase();

    $('#table_produit tbody tr').filter(function () {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
    });
});
  
  $('.formulaire').on('submit',function(e){
      e.preventDefault();

      var donnees = $(this).serialize();
  
      lien = $(this).attr('action');

      swal.fire({
          html: '<p>Patienter<span class="animated-dots"></span></p>',
          imageUrl: './dist/loader.gif',
          showConfirmButton: false,
          allowOutsideClick: false,
      });

      $.post(lien, donnees, function(response) {
          
          if (response == 1) {

            swal.fire({
                text: "Bien ajouté !",
                icon: "success",
                showConfirmButton: false,
                timer: 2000,
            });

            document.location.reload();
              
          }
          else
          {

            swal.fire({
                text: "Il y a un problème !",
                icon: "warning",
                showConfirmButton: false,
                timer: 4000,
            });

          }
  
      })

  });
        $('.btn_deconnexion').on('click',function(e){
            e.preventDefault();
            swal.fire({
                text: 'Vous voulez vous déconnecter ?',
                icon: "question",
                showConfirmButton: true,
                showCancelButton: true,
                confirmButtonColor: '#3885d6',
                cancelButtonColor:'#d33',
                confirmButtonText: 'Oui',
                cancelButtonText: 'Non',
            }).then((result)=>{
                if(result.value){
                    document.location.href='deconnexion.php';
                }
            })
        })
        
    </script>
    <script>

        if(window.matchMedia("(max-width:818px)").matches)
        {

            $('.btn btn-primary d-none d-sm-inline-block').css('display', 'none');
            $('#cadrer').addClass('table-responsive');
            $('body').css({
                fontSize : '10px'
            });
            $('h1 , .page-title').css({
                fontSize : '15px'
            });
            $('th').css({
                fontSize : '9px'
            });


        }
    </script>
  </body>
</html>